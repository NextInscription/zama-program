<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SDK è°ƒè¯•æµ‹è¯•é¡µé¢</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
      }
      button {
        background: #667eea;
        color: white;
        border: none;
        padding: 12px 24px;
        margin: 10px 5px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
      }
      button:hover {
        background: #5568d3;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      input {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .log {
        background: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 15px;
        margin-top: 20px;
        max-height: 400px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 12px;
      }
      .log-entry {
        margin: 5px 0;
        padding: 5px;
        border-left: 3px solid #667eea;
        padding-left: 10px;
      }
      .log-error {
        border-left-color: #dc3545;
        color: #dc3545;
      }
      .log-success {
        border-left-color: #28a745;
        color: #28a745;
      }
      .status {
        display: inline-block;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        margin-left: 10px;
      }
      .status-connected {
        background: #d4edda;
        color: #155724;
      }
      .status-disconnected {
        background: #f8d7da;
        color: #721c24;
      }
    </style>
  </head>
  <body>
    <!-- Polyfill for Node.js global variables in browser -->
    <script>
      window.global = window.globalThis;
      window.process = window.process || { env: {} };
    </script>

    <div class="container">
      <h1>ğŸ”§ SDK è°ƒè¯•æµ‹è¯•é¡µé¢</h1>
      <p>ç”¨äºæµ‹è¯•å’Œè°ƒè¯• Zama Private Transfer SDK</p>

      <div>
        <h3>
          è¿æ¥çŠ¶æ€:
          <span id="status" class="status status-disconnected">æœªè¿æ¥</span>
        </h3>
        <button id="connectBtn">è¿æ¥ MetaMask</button>
        <div id="walletInfo" style="margin-top: 10px; color: #666"></div>
      </div>

      <hr />

      <div>
        <h3>æµ‹è¯•å­˜æ¬¾</h3>
        <input type="text" id="depositAmount" placeholder="é‡‘é¢ (ETH)" value="0.001" />
        <button id="depositBtn" disabled>æµ‹è¯•å­˜æ¬¾</button>
      </div>

      <div id="passwordDisplay" style="display: none; margin-top: 10px">
        <h4 style="color: #dc3545">âš ï¸ å¯†ç å¯†é’¥ï¼ˆè¯·å¤åˆ¶ä¿å­˜ï¼‰:</h4>
        <input type="text" id="passwordKey" readonly style="background: #fff3cd" />
      </div>

      <hr />

      <div>
        <h3>æµ‹è¯•ææ¬¾</h3>
        <input type="text" id="withdrawPassword" placeholder="å¯†ç " />
        <input type="text" id="withdrawAmount" placeholder="é‡‘é¢ (ETH)" value="0.001" />
        <button id="checkVaultBtn" disabled>æŸ¥è¯¢é‡‘åº“</button>
        <button id="withdrawBtn" disabled>æµ‹è¯•ææ¬¾</button>
      </div>

      <hr />

      <div>
        <h3>æµ‹è¯•èµé‡‘ä»»åŠ¡</h3>
        <button id="loadTasksBtn" disabled>åŠ è½½ä»»åŠ¡åˆ—è¡¨</button>
      </div>

      <hr />

      <div>
        <h3>ğŸ“‹ è°ƒè¯•æ—¥å¿—</h3>
        <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
        <div id="log" class="log"></div>
      </div>
    </div>

    <script type="module">
      // å¯¼å…¥SDKå’Œåˆå§‹åŒ–å‡½æ•°
      import { PrivateTransferSDK, TransferType } from './dist/index.mjs';
      import { initSDK } from '@zama-fhe/relayer-sdk/web';

      let sdk = null;
      let currentPassword = null;
      let sdkInitialized = false;

      // åˆå§‹åŒ–Zama FHE SDK
      console.log('Initializing Zama FHE SDK...');

      initSDK({
        tfheParams: '/wasm/tfhe_bg.wasm',
        kmsParams: '/wasm/kms_lib_bg.wasm',
      })
        .then(() => {
          console.log('âœ… Zama FHE SDK initialized successfully');
          sdkInitialized = true;
          log('âœ… Zama FHE SDK åˆå§‹åŒ–æˆåŠŸ', 'success');
        })
        .catch((error) => {
          console.error('âŒ Failed to initialize Zama FHE SDK:', error);
          log(`âš ï¸ Zama FHE SDK åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
          log('å°è¯•ç»§ç»­è¿è¡Œï¼ˆå¯èƒ½éƒ¨åˆ†åŠŸèƒ½ä¸å¯ç”¨ï¼‰', 'error');
          sdkInitialized = true; // å…è®¸ç»§ç»­ï¼Œä½†ä¼šåœ¨ä½¿ç”¨æ—¶æŠ¥é”™
        });

      // æ—¥å¿—å‡½æ•°
      function log(message, type = 'info') {
        const logDiv = document.getElementById('log');
        const entry = document.createElement('div');
        entry.className = `log-entry ${type === 'error' ? 'log-error' : type === 'success' ? 'log-success' : ''}`;
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logDiv.appendChild(entry);
        logDiv.scrollTop = logDiv.scrollHeight;
        console.log(message);
      }

      window.clearLog = function () {
        document.getElementById('log').innerHTML = '';
      };

      // è¿æ¥é’±åŒ…
      document.getElementById('connectBtn').addEventListener('click', async () => {
        try {
          // æ£€æŸ¥Zama SDKæ˜¯å¦å·²åˆå§‹åŒ–
          if (!sdkInitialized) {
            log('ç­‰å¾… Zama FHE SDK åˆå§‹åŒ–...', 'error');
            throw new Error('Zama FHE SDK å°šæœªåˆå§‹åŒ–ï¼Œè¯·ç¨åå†è¯•');
          }

          log('æ­£åœ¨è¿æ¥ MetaMask...');

          if (!window.ethereum) {
            throw new Error('è¯·å…ˆå®‰è£… MetaMask!');
          }

          // è¯·æ±‚è´¦æˆ·è®¿é—®
          const accounts = await window.ethereum.request({
            method: 'eth_requestAccounts',
          });
          log(`âœ… è´¦æˆ·å·²è¿æ¥: ${accounts[0]}`, 'success');

          // æ£€æŸ¥ç½‘ç»œ
          const chainId = await window.ethereum.request({
            method: 'eth_chainId',
          });
          log(`ç½‘ç»œ Chain ID: ${chainId} (åº”ä¸º 0xaa36a7 Sepolia)`);

          if (chainId !== '0xaa36a7') {
            log(
              'âš ï¸ è­¦å‘Š: è¯·åˆ‡æ¢åˆ° Sepolia æµ‹è¯•ç½‘! å½“å‰ç½‘ç»œä¸æ˜¯ Sepolia',
              'error'
            );
          }

          // åˆ›å»ºSDKå®ä¾‹
          log('æ­£åœ¨åˆå§‹åŒ– SDK...');
          sdk = new PrivateTransferSDK({
            contractAddress: '0x8ea2dDD9DD550d500B4cef4C560fE27cde37508D',
          });

          // è®¾ç½®è°ƒè¯•å›è°ƒ
          sdk.setCallbacks({
            onTransactionSubmitted: (txHash) => {
              log(`ğŸ“¤ äº¤æ˜“å·²æäº¤: ${txHash}`, 'success');
            },
            onTransactionConfirmed: (receipt) => {
              log(`âœ… äº¤æ˜“å·²ç¡®è®¤ï¼ŒåŒºå—: ${receipt.blockNumber}`, 'success');
            },
            onError: (error) => {
              log(`âŒ é”™è¯¯: ${error.message}`, 'error');
            },
          });

          await sdk.initialize(window.ethereum);
          log('âœ… SDK åˆå§‹åŒ–æˆåŠŸ!', 'success');

          const signerAddress = await sdk.getSignerAddress();
          log(`ç­¾åè€…åœ°å€: ${signerAddress}`);

          // æ›´æ–°UI
          document.getElementById('status').textContent = 'å·²è¿æ¥';
          document.getElementById('status').className = 'status status-connected';
          document.getElementById('walletInfo').textContent = `é’±åŒ…: ${signerAddress}`;
          document.getElementById('depositBtn').disabled = false;
          document.getElementById('checkVaultBtn').disabled = false;
          document.getElementById('withdrawBtn').disabled = false;
          document.getElementById('loadTasksBtn').disabled = false;
          document.getElementById('connectBtn').textContent = 'å·²è¿æ¥';
          document.getElementById('connectBtn').disabled = true;
        } catch (error) {
          log(`âŒ è¿æ¥å¤±è´¥: ${error.message}`, 'error');
          console.error(error);
        }
      });

      // æµ‹è¯•å­˜æ¬¾
      document.getElementById('depositBtn').addEventListener('click', async () => {
        try {
          const amount = document.getElementById('depositAmount').value;
          if (!amount || parseFloat(amount) <= 0) {
            throw new Error('è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢');
          }

          log(`å¼€å§‹å­˜æ¬¾: ${amount} ETH`);
          log('å­˜æ¬¾ç±»å‹: ä»»ä½•äººå‡­å¯†ç å¯æå–');

          const depositBtn = document.getElementById('depositBtn');
          depositBtn.disabled = true;
          depositBtn.textContent = 'å¤„ç†ä¸­...';

          const result = await sdk.deposit({
            transferType: TransferType.ANYONE_WITH_PASSWORD,
            amount: amount,
          });

          log(`âœ… å­˜æ¬¾æˆåŠŸ!`, 'success');
          log(`äº¤æ˜“å“ˆå¸Œ: ${result.transactionHash}`);
          log(`åŒºå—å·: ${result.blockNumber}`);
          log(`å¯†ç  (uint256): ${result.password.toString()}`);
          log(`å¯†ç ç§é’¥: ${result.privateKey}`, 'success');
          log(`å¯†ç åœ°å€: ${result.passwordAddress}`);
          log(`æ¥æ”¶è€…åœ°å€: ${result.recipientAddress}`);

          // æ˜¾ç¤ºå¯†ç 
          currentPassword = result.privateKey;
          document.getElementById('passwordKey').value = currentPassword;
          document.getElementById('passwordDisplay').style.display = 'block';
          document.getElementById('withdrawPassword').value = currentPassword;

          depositBtn.disabled = false;
          depositBtn.textContent = 'æµ‹è¯•å­˜æ¬¾';
        } catch (error) {
          log(`âŒ å­˜æ¬¾å¤±è´¥: ${error.message}`, 'error');
          console.error(error);
          document.getElementById('depositBtn').disabled = false;
          document.getElementById('depositBtn').textContent = 'æµ‹è¯•å­˜æ¬¾';
        }
      });

      // æŸ¥è¯¢é‡‘åº“
      document.getElementById('checkVaultBtn').addEventListener('click', async () => {
        try {
          const password = document.getElementById('withdrawPassword').value;
          if (!password) {
            throw new Error('è¯·è¾“å…¥å¯†ç ');
          }

          log(`æŸ¥è¯¢é‡‘åº“ï¼Œå¯†ç : ${password.substring(0, 10)}...`);

          const checkBtn = document.getElementById('checkVaultBtn');
          checkBtn.disabled = true;
          checkBtn.textContent = 'æŸ¥è¯¢ä¸­...';

          const vaultInfo = await sdk.getVaultInfo(password);

          log(`âœ… é‡‘åº“ä¿¡æ¯:`, 'success');
          log(`  - æ˜¯å¦å·²å‘å¸ƒ: ${vaultInfo.isPublished}`);
          log(`  - è½¬è´¦ç±»å‹: ${vaultInfo.transferType}`);
          log(`  - ä½™é¢: ${vaultInfo.balanceEth} ETH`);
          log(`  - å¯†ç åœ°å€: ${vaultInfo.passwordAddress}`);
          log(`  - å­˜æ¬¾äºº: ${vaultInfo.depositor}`);
          log(`  - å…è®¸åœ°å€: ${vaultInfo.allowAddress}`);

          checkBtn.disabled = false;
          checkBtn.textContent = 'æŸ¥è¯¢é‡‘åº“';
        } catch (error) {
          log(`âŒ æŸ¥è¯¢å¤±è´¥: ${error.message}`, 'error');
          console.error(error);
          document.getElementById('checkVaultBtn').disabled = false;
          document.getElementById('checkVaultBtn').textContent = 'æŸ¥è¯¢é‡‘åº“';
        }
      });

      // æµ‹è¯•ææ¬¾
      document.getElementById('withdrawBtn').addEventListener('click', async () => {
        try {
          const password = document.getElementById('withdrawPassword').value;
          const amount = document.getElementById('withdrawAmount').value;

          if (!password) {
            throw new Error('è¯·è¾“å…¥å¯†ç ');
          }
          if (!amount || parseFloat(amount) <= 0) {
            throw new Error('è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢');
          }

          log(`å¼€å§‹ææ¬¾: ${amount} ETH`);

          const withdrawBtn = document.getElementById('withdrawBtn');
          withdrawBtn.disabled = true;
          withdrawBtn.textContent = 'å¤„ç†ä¸­...';

          const result = await sdk.withdraw({
            privateKey: password,
            amount: amount,
          });

          log(`âœ… ææ¬¾æˆåŠŸ!`, 'success');
          log(`äº¤æ˜“å“ˆå¸Œ: ${result.transactionHash}`);
          log(`ææ¬¾é‡‘é¢: ${result.amount} ETH`);

          withdrawBtn.disabled = false;
          withdrawBtn.textContent = 'æµ‹è¯•ææ¬¾';
        } catch (error) {
          log(`âŒ ææ¬¾å¤±è´¥: ${error.message}`, 'error');
          console.error(error);
          document.getElementById('withdrawBtn').disabled = false;
          document.getElementById('withdrawBtn').textContent = 'æµ‹è¯•ææ¬¾';
        }
      });

      // åŠ è½½ä»»åŠ¡
      document.getElementById('loadTasksBtn').addEventListener('click', async () => {
        try {
          log('åŠ è½½èµé‡‘ä»»åŠ¡åˆ—è¡¨...');

          const loadBtn = document.getElementById('loadTasksBtn');
          loadBtn.disabled = true;
          loadBtn.textContent = 'åŠ è½½ä¸­...';

          const feeRate = await sdk.getFeeRate();
          log(`å½“å‰ä½£é‡‘è´¹ç‡: ${feeRate / 10}%`);

          const tasks = await sdk.getBountyTasks();
          log(`âœ… æ‰¾åˆ° ${tasks.length} ä¸ªèµé‡‘ä»»åŠ¡`, 'success');

          tasks.forEach((task, index) => {
            log(`ä»»åŠ¡ #${index + 1}:`);
            log(`  - æ€»é‡‘é¢: ${task.totalReward} ETH`);
            log(`  - ä½£é‡‘: ${task.commission} ETH`);
          });

          if (tasks.length === 0) {
            log('å½“å‰æ²¡æœ‰å¯ç”¨çš„èµé‡‘ä»»åŠ¡');
          }

          loadBtn.disabled = false;
          loadBtn.textContent = 'åŠ è½½ä»»åŠ¡åˆ—è¡¨';
        } catch (error) {
          log(`âŒ åŠ è½½å¤±è´¥: ${error.message}`, 'error');
          console.error(error);
          document.getElementById('loadTasksBtn').disabled = false;
          document.getElementById('loadTasksBtn').textContent = 'åŠ è½½ä»»åŠ¡åˆ—è¡¨';
        }
      });

      // åˆå§‹åŒ–æ—¥å¿—
      log('é¡µé¢å·²åŠ è½½ï¼Œè¯·å…ˆè¿æ¥ MetaMask');
      log('ç¡®ä¿ä½ å·²ç»åˆ‡æ¢åˆ° Sepolia æµ‹è¯•ç½‘');
      log('ç¡®ä¿ä½ çš„é’±åŒ…æœ‰è¶³å¤Ÿçš„æµ‹è¯• ETH');
    </script>
  </body>
</html>
